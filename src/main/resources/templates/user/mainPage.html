<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MainPage</title>
    <link rel="stylesheet" href="/style.css" />
    <th:block th:replace="~{common/head :: library}"></th:block>
  </head>
  <body>
    <style></style>
    <!-- Corrected th:replace to properly include the navbar fragment -->
    <th:block th:replace="~{common/navigation :: navbar}" />

    <ul class="nav nav-tabs" id="categoryTabs">
      <!-- Categories will be dynamically inserted here -->
    </ul>

    <div id="productContainer"></div>

    <th:block th:replace="~{common/footer :: footer}" />

    <script>
      // Fetch all categories and dynamically generate the category tabs
      fetch("/category/get-all")
        .then((response) => response.json())
        .then((data) => {
          const categoryTabs = document.getElementById("categoryTabs");

          // Add the "All" tab first
          let allTab = `<li class="nav-item">
                      <a class="nav-link active" href="#" data-category="all">All</a>
                    </li>`;
          categoryTabs.innerHTML = allTab;

          // Define the required tab order
          const categoryOrder = ["Women", "Men", "Kids", "Accessories"];
          const categories = data.categoryList;

          // Filter and reorder the categories based on the predefined order
          categoryOrder.forEach((categoryName) => {
            const category = categories.find(
              (cat) => cat.categoryName === categoryName,
            );
            if (category) {
              const categoryTab = `<li class="nav-item">
                                 <a class="nav-link" href="#" data-category="${category.id}">${category.categoryName}</a>
                               </li>`;
              categoryTabs.insertAdjacentHTML("beforeend", categoryTab);
            }
          });

          // Fetch products for the "All" category initially
          loadProducts("all");
        })
        .catch((error) => {
          console.error("Error fetching categories:", error);
        });

      // Event listener to handle category click and load corresponding products
      document
        .getElementById("categoryTabs")
        .addEventListener("click", (event) => {
          event.preventDefault();

          if (event.target.tagName === "A") {
            const categoryId = event.target.getAttribute("data-category");
            loadProducts(categoryId);

            // Highlight the active tab
            const tabs = document.querySelectorAll(".nav-link");
            tabs.forEach((tab) => tab.classList.remove("active"));
            event.target.classList.add("active");
          }
        });

      // Function to load products based on the selected category
      function loadProducts(categoryId) {
        fetch(
          categoryId === "all"
            ? "/product/get-all"
            : `/product/get-by-category-id/${categoryId}`,
        )
          .then((response) => response.json())
          .then((data) => {
            const productList = data.productList;
            const container = document.getElementById("productContainer");
            container.innerHTML = ""; // Clear the previous products

            productList.forEach((product) => {
              const productCard = `
            <div class="card" style="width: 18rem">
              <img class="card-img-top" src="${product.image || "dress.jpg"}" alt="Card image cap" />
              <div class="card-body">
                <h5 class="card-title">${product.name}</h5>
                <span>${product.price}</span>
              </div>
              <div class="card-body">
                <a href="#" class="card-link">
                  <input type="button" value="자세히 보기" />
                </a>
              </div>
            </div>
          `;
              container.insertAdjacentHTML("beforeend", productCard);
            });
          })
          .catch((error) => {
            console.error("Error fetching products:", error);
          });
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
