<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cart Page</title>

    <!-- Bootstrap 5.1.3 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <div th:replace="~{common/navigation :: navbar}"></div>
    <div class="container mt-5">
      <h2 class="text-center mb-4">Your Cart</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th scope="col">Product Name</th>
            <th scope="col">Price</th>
            <th scope="col">Quantity</th>
            <th scope="col">Total</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="cart-items">
          <!-- 여기서 동적으로 데이터가 채워짐 -->
        </tbody>
      </table>
      <div class="text-center mt-4">
        <button class="btn btn-success" id="checkout-btn">
          Proceed to Checkout
        </button>
        <!-- 장바구니 비우기 버튼 -->
        <button class="btn btn-danger" id="clearCartBtn">Clear Cart</button>
      </div>
    </div>

    <script>
      const userId = 4; // 로그인된 사용자 ID

      // 장바구니 아이템 리스트 가져오기 ============================================================
      async function getCartItems() {
        // 기존 장바구니 아이템 리스트를 비우기 위해 테이블 요소 가져오기
        const cartItemsList = document.getElementById("cart-items");
        cartItemsList.innerHTML = ""; // 기존 테이블 내용 비우기

        // 로컬 스토리지에서 장바구니 정보 가져오기
        let cartData = getValuesFromLocalStorage("cart");
        // 장바구니 데이터가 없으면 빈 배열로 초기화
        let cartItems = cartData.cartItemDto;
        // 서버에서 받은 데이터(카트 아이템 리스트)로 테이블 채우기
        cartItems.forEach((item) => {

          // 테이블 행 생성
          const row = document.createElement("tr");
          // 행 내용 채우기
          row.innerHTML = `
                        <td>${item.product.name}</td>
                        <td>${item.product.price}</td>
                        <td>
                            <input type="number" class="form-control" value="${item.quantity}" min="1" onchange="updateQuantity(${cartData.id}, ${item.product.id}, this.value)" />
                        </td>
                        <td>${item.price}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeItem(${item.product.id})">Remove</button>
                        </td>
                    `;
          // 테이블에 행 추가
          cartItemsList.appendChild(row);
        });
      }

      function updateQuantity(cartId, productId, quantity) {
        fetch(`/api/cart-item/update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            cartId: cartId,
            productId: productId,
            quantity: quantity,
          }),
        })
          .then((response) => response.json())
          .then(async () => {
            // Fetch the updated cart item data
            await getCart();
            // Reload the cart items
            await getCartItems();
          })
          .catch((error) => console.error("Error updating quantity:", error));
      }

      // 장바구니 아이템 삭제
      function removeItem(productId) {
        fetch(`/api/cart-item/delete/`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.message);
            getCartItems(); // 아이템 삭제 후 장바구니 아이템을 다시 로드
          })
          .catch((error) => console.error("Error removing item:", error));
      }

      // 장바구니 비우기
      document
        .getElementById("clearCartBtn")
        .addEventListener("click", function () {
          fetch(`/api/cart-item/clear`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ userId: userId }),
          })
            .then((response) => response.json())
            .then((data) => {
              alert(data.message);
              getCartItems(); // 장바구니 비운 후 장바구니 아이템을 다시 로드
            })
            .catch((error) => console.error("Error clearing cart:", error));
        });

      // 페이지 로드 시 장바구니 아이템 목록 불러오기
      document.addEventListener("DOMContentLoaded", getCartItems);
    </script>
  </body>
</html>
