<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory</title>
    <th:block th:replace="~{common/head :: library}"></th:block>
    <style>
      th {
        text-transform: capitalize;
      }
    </style>
  </head>
  <body>
    <th:block th:replace="~{common/navigation :: adminnavbar}" />
    <main class="flex-grow-1">
      <div class="container">
        <h3>상품(재고)관리</h3>
        <hr />
        <table>
          <thead>
            <tr>
              <th>product</th>
              <th>category</th>
              <th>quantity</th>
              <th>price</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="editable-table"></tbody>
        </table>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const tableBodyElement = document.getElementById("tableBody");

        const createRow = (product, category, quantity, price) => {
          const row = document.createElement("tr");
          const productElement = document.createElement("td");
          const categoryElement = document.createElement("td");
          const quantityElement = document.createElement("td");
          const priceElement = document.createElement("td");

          productElement.textContent = product;
          productElement.classList.add("product-name");
          categoryElement.textContent = category;
          categoryElement.classList.add("category-name");
          quantityElement.textContent = quantity;
          quantityElement.classList.add("quantity");
          priceElement.textContent = `${price}`;
          priceElement.classList.add("price");

          row.appendChild(productElement);
          row.appendChild(categoryElement);
          row.appendChild(quantityElement);
          row.appendChild(priceElement);

          return row;
        };

        // Fetch all products from the server
        function loadData() {
          fetch("/product/get-all", {
            include: "credentials",
          })
            .then((response) => response.json())
            .then((data) => {
              const reversedData = [...data.productList].reverse();
              reversedData.forEach((element) => {
                console.log(element);
                const row = createRow(
                  element.name,
                  element.category.categoryName,
                  element.quantity,
                  element.price,
                );
                tableBodyElement.appendChild(row);
              });
            })
            .catch((error) =>
              console.error("Error loading categories:", error),
            );
        }

        // 초기 데이터 로드
        loadData();

        /**
         * Loading Category Lists
         * @returns catoryList
         */
        const categoryLists = () => {
          return null;
        };

        document
          .getElementById("tableBody")
          .addEventListener("click", function (e) {
            const cell = e.target.closest("td");
            if (!cell || cell.classList.contains("action-cell")) return; // Skip action cells

            const originalContent = cell.textContent;
            console.log(cell.className);
            /** Select the input type based on the cell class */
            // const input =
            //     cell.className === "category-name"
            //         ? document.createElement("input")
            //         : document.createElement("select");
            const input = document.createElement("input");
            switch (cell.className) {
              case "product-name":
                input.type = "text";
                break;
              case "category-name":
                /** TODO Load data from categoryLists() */
                input.type = "text";
                break;
              case "quantity":
                input.type = "number";
                break;
              case "price":
                input.type = "number";
                break;
              default:
                return;
            }
            input.value = originalContent;
            input.className = "form-control";

            cell.textContent = "";
            cell.appendChild(input);
            input.focus();

            // Handle saving when focus is lost
            input.addEventListener("blur", function () {
              cell.textContent = this.value;
            });

            // Handle Enter key
            input.addEventListener("keypress", function (e) {
              if (e.key === "Enter") {
                this.blur();
              }
            });
          });
      });
      function updateProduct(productId, categoryId, name, quantity, price) {
        const requestData = {
          categoryId: categoryId,
          name: name,
          quantity: quantity,
          price: price,
        };

        fetch(`/product/update/${productId}`, {
          method: "POST",
          include: "credentials",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestData),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Product updated successfully:", data);
            // Optionally, refresh the product list or update the UI
          })
          .catch((error) => {
            console.error("Error updating product:", error);
          });
      }
    </script>
  </body>
</html>
